<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Faks Android</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; background: #121212; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #toolbar { background: #3b82f6; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        #my-id-info { background: #1e1e1e; font-size: 11px; padding: 5px 15px; color: #888; display: flex; justify-content: space-between; }
        #contacts-bar { background: #1e1e1e; padding: 10px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 1px solid #333; }
        .c-item { background: #333; padding: 10px 15px; border-radius: 4px; white-space: nowrap; border-left: 3px solid #3b82f6; cursor: pointer; }
        .c-item.active { background: #444; border-left-color: #fff; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px; border-radius: 4px; max-width: 85%; line-height: 1.4; position: relative; }
        .mine { background: #005a9e; align-self: flex-end; }
        .others { background: #2c2c2c; align-self: flex-start; }
        .secret { border: 1px dashed #ff4500; font-style: italic; }
        .input-box { background: #1e1e1e; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        .input-row { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; background: transparent; border: none; border-bottom: 2px solid #3b82f6; color: white; padding: 8px; outline: none; }
        button { background: #3b82f6; border: none; color: white; border-radius: 2px; padding: 8px 15px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="toolbar">
        <span id="chat-title">Faks Android</span>
        <button onclick="addContact()" style="background:#1e1e1e; font-size:12px;">+ –ö–û–ù–¢–ê–ö–¢</button>
    </div>
    <div id="my-id-info">
        <span id="my-id-text">–í–∞—à ID: –∑–∞–≥—Ä—É–∑–∫–∞...</span>
        <span onclick="subscribePush()" style="color:#3b82f6; cursor:pointer;">üîî –í–ö–õ. PUSH</span>
    </div>
    <div id="contacts-bar"></div>
    <div id="messages"></div>
    <div class="input-box">
        <div style="display:flex; justify-content: space-between;">
            <label style="font-size: 12px; color: #ff4500;"><input type="checkbox" id="isSecret"> –°–ï–ö–†–ï–¢–ù–û</label>
            <span onclick="clearHist()" style="color:#555; font-size:12px; cursor:pointer;">–û–ß–ò–°–¢–ò–¢–¨ –•–û–î</span>
        </div>
        <div class="input-row">
            <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()">–û–¢–ü–†.</button>
        </div>
    </div>

<script>
// –ü—Ä–æ—Å–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å—Ä–∞–∑—É
if (Notification.permission !== "granted" && Notification.permission !== "denied") {
    Notification.requestPermission();
}
navigator.serviceWorker.register('sw.js')    
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

    async function subscribePush() {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') alert("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã!");
    }

    const API_KEY = 'M9FSjQ.1eCbcw:gmIuogBbVXZnMUew6GlHaBQBCmrsBDyNTNiz_vtR-r0';
    const ably = new Ably.Realtime(API_KEY);
    let myId = localStorage.getItem('faks_myid_and') || 'and-' + Math.random().toString(36).substr(2, 5);
    localStorage.setItem('faks_myid_and', myId);
    document.getElementById('my-id-text').textContent = "–í–∞—à ID: " + myId;

    let currentChannel = null;
    let activeId = null;
    let contacts = JSON.parse(localStorage.getItem('and_contacts') || '[]');

    function save() { localStorage.setItem('and_contacts', JSON.stringify(contacts)); render(); }

    function addContact() {
        const id = prompt("ID –¥—Ä—É–≥–∞:"); if (!id) return;
        const name = prompt("–ò–º—è:"); if (!name) return;
        if(!contacts.find(c => c.id === id)) { contacts.push({id, name}); save(); }
    }

    function render() {
        const bar = document.getElementById('contacts-bar');
        bar.innerHTML = "";
        contacts.forEach(c => {
            const d = document.createElement('div');
            d.className = 'c-item' + (activeId === c.id ? ' active' : ''); 
            d.textContent = c.name;
            d.onclick = () => startChat(c.id, c.name);
            bar.appendChild(d);
        });
    }

   function startChat(id, name) {
    if(currentChannel) currentChannel.unsubscribe();
    activeId = id;
    render();
    document.getElementById('chat-title').textContent = name;
    document.getElementById('messages').innerHTML = "";
    const room = [myId, id].sort().join('_');
    currentChannel = ably.channels.get(room);
    
    // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é (—Ç–µ —Å–∞–º—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ –ø—Ä–∏—à–ª–∏, –ø–æ–∫–∞ –º—ã –±—ã–ª–∏ "–æ—Ñ–ª–∞–π–Ω")
    currentChannel.history({limit: 30}, (err, page) => {
        if (!err) {
            page.items.reverse().forEach(m => {
                renderMsg(m.data.t, m.data.s === myId, m.data.sec);
            });
        }
    });

    currentChannel.subscribe('msg', m => {
        if(m.data.s !== myId) {
            // –ï—Å–ª–∏ —á–∞—Ç –Ω–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º
            if(!m.data.sec) saveMsg(id, m.data.t, m.data.s);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –æ–∫–Ω–µ —á–∞—Ç–∞
            renderMsg(m.data.t, false, m.data.sec);
            
            // –ì–õ–ê–í–ù–û–ï: –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Å–≤–µ—Ä–Ω—É–ª –≤–∫–ª–∞–¥–∫—É (–Ω–µ –≤ —Å–µ—Ç–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å)
            if (document.hidden || document.visibilityState === 'hidden') {
                
                // 1. –í–∏–±—Ä–∞—Ü–∏—è (–¥–ª—è Android)
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                
                // 2. –ó–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª (—Å–æ–∑–¥–∞–µ–º –µ–≥–æ –Ω–∞ –ª–µ—Ç—É)
                let audio = new Audio('https://www.soundjay.com/buttons/beep-07a.mp3');
                audio.play();

                // 3. –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                if (Notification.permission === "granted") {
                    const n = new Notification("Faks: " + name, {
                        body: m.data.t,
                        icon: "icon-192.png",
                        tag: "faks-msg" // –ß—Ç–æ–±—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Å–ø–∞–º–∏–ª–∏, –∞ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å
                    });
                    
                    // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —á–∞—Ç
                    n.onclick = function() {
                        window.focus();
                        this.close();
                    };
                }
            }
        }
    });
}

    function send() {
        const i = document.getElementById('msgInput');
        const sec = document.getElementById('isSecret').checked;
        if(!i.value || !currentChannel) return;
        currentChannel.publish('msg', {t: i.value, s: myId, sec: sec});
        if(!sec) saveMsg(activeId, i.value, myId);
        renderMsg(i.value, true, sec);
        i.value = "";
    }

    function saveMsg(cid, t, s) {
        let h = JSON.parse(localStorage.getItem('h_'+cid) || '[]');
        h.push({t, s}); if(h.length > 50) h.shift();
        localStorage.setItem('h_'+cid, JSON.stringify(h));
    }

    function renderMsg(t, m, sec) {
        const d = document.createElement('div');
        d.className = 'msg ' + (m ? 'mine' : 'others') + (sec ? ' secret' : '');
        d.textContent = t;
        document.getElementById('messages').appendChild(d);
        document.getElementById('messages').scrollTop = 99999;
        if(sec) setTimeout(() => d.remove(), 60000);
    }

    function clearHist() { if(activeId) { localStorage.removeItem('h_'+activeId); document.getElementById('messages').innerHTML = ""; } }
    render();

    setInterval(() => {
        if (document.hidden && currentChannel) {
            currentChannel.publish('ping', { time: Date.now(), s: myId });
        }
    }, 20000);

// 1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
if (Notification.permission !== "granted") {
    Notification.requestPermission();
}

// 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å—Ç–∞—Ä—Ç–∞ —á–∞—Ç–∞
function startChat(id, name) {
    if(currentChannel) currentChannel.unsubscribe();
    activeId = id;
    render();
    document.getElementById('chat-title').textContent = name;
    document.getElementById('messages').innerHTML = "";
    const room = [myId, id].sort().join('_');
    currentChannel = ably.channels.get(room);
    
    const hist = JSON.parse(localStorage.getItem('h_'+id) || '[]');
    hist.forEach(m => renderMsg(m.t, m.s === myId, false));

    currentChannel.subscribe('msg', m => {
        if(m.data.s !== myId) {
            if(!m.data.sec) saveMsg(id, m.data.t, m.data.s);
            renderMsg(m.data.t, false, m.data.sec);
            
            // –ú–ê–ì–ò–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ë–ï–ó –°–ï–†–í–ï–†–ê
            if (document.hidden) {
                // –í–∏–±—Ä–∞—Ü–∏—è
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –ø–ª–∞—à–∫—É
                const notification = new Notification("Faks: " + name, {
                    body: m.data.t,
                    tag: id, // —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –∑–∞–º–µ–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞
                    renotify: true
                });

                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
            }
        }
    });
}
// –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å "–∑–∞—Å—ã–ø–∞–Ω–∏–µ" –¥–ª—è Android APK
if ('wakeLock' in navigator) {
    let wakeLock = null;
    const requestWakeLock = async () => {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('APK –Ω–µ —É—Å–Ω–µ—Ç!');
        } catch (err) {
            console.log('–°–∏—Å—Ç–µ–º–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ —É–¥–µ—Ä–∂–∞–Ω–∏–µ');
        }
    };
    requestWakeLock();
}

// –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞ (–∫–æ–≥–¥–∞ –Ω–∞–∂–∏–º–∞—é—Ç –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥")
window.onbeforeunload = function() {
    return "–ï—Å–ª–∏ –≤—ã –∑–∞–∫—Ä–æ–µ—Ç–µ Faks, —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å!";
};
</script>
</body>
</html>
