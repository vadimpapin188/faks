<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android Messenger</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3b82f6">

    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; background: #121212; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #toolbar { background: #3b82f6; padding: 15px; font-size: 20px; font-weight: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        #contacts-bar { background: #1e1e1e; padding: 10px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 1px solid #333; }
        .c-item { background: #333; padding: 8px 15px; border-radius: 4px; white-space: nowrap; font-size: 14px; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px; border-radius: 4px; max-width: 85%; elevation: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .mine { background: #005a9e; align-self: flex-end; }
        .others { background: #2c2c2c; align-self: flex-start; }
        .input-box { background: #1e1e1e; padding: 10px; display: flex; gap: 10px; }
        input { flex: 1; background: transparent; border: none; border-bottom: 2px solid #3b82f6; color: white; padding: 5px; outline: none; }
        #my-id-info { font-size: 12px; padding: 5px 15px; color: #aaa; background: #1e1e1e; }
    </style>
</head>
<body>
    <div id="toolbar">VadimChat Android</div>
    <div id="my-id-info">Загрузка...</div>
    <div id="contacts-bar">
        <div class="c-item" onclick="addContact()" style="background:#3b82f6">+ ДОБАВИТЬ</div>
        <div id="c-list" style="display:flex; gap:10px;"></div>
    </div>
    <div id="messages"></div>
    <div class="input-box">
        <input type="text" id="msgInput" placeholder="Введите сообщение...">
        <button onclick="send()" style="background:#3b82f6; border:none; color:white; border-radius:4px; padding:10px;">SEND</button>
    </div>

    <script>
        const API_KEY = 'M9FSjQ.1eCbcw:gmIuogBbVXZnMUew6GlHaBQBCmrsBDyNTNiz_vtR-r0';
        const ably = new Ably.Realtime(API_KEY);
        let myId = localStorage.getItem('messenger_id_and') || 'and-' + Math.random().toString(36).substr(2, 5);
        localStorage.setItem('messenger_id_and', myId);
        document.getElementById('my-id-info').textContent = "Ваш ID: " + myId;

        let currentChannel = null;
        let contacts = JSON.parse(localStorage.getItem('and_contacts') || '[]');

        ably.channels.get('private:' + myId).subscribe('add_me', m => {
            if (!contacts.includes(m.data.id)) { contacts.push(m.data.id); save(); }
        });

        function save() { localStorage.setItem('and_contacts', JSON.stringify(contacts)); render(); }
        function render() {
            const l = document.getElementById('c-list'); l.innerHTML = "";
            contacts.forEach(id => {
                const d = document.createElement('div'); d.className = 'c-item';
                d.textContent = id; d.onclick = () => startChat(id); l.appendChild(d);
            });
        }
        function addContact() { const id = prompt("Введите ID:"); if(id) { contacts.push(id); save(); startChat(id); } }

        function startChat(id) {
            if(currentChannel) currentChannel.unsubscribe();
            document.getElementById('messages').innerHTML = "";
            ably.channels.get('private:' + id).publish('add_me', {id: myId});
            const room = [myId, id].sort().join('_');
            currentChannel = ably.channels.get(room);
            currentChannel.subscribe('msg', m => { if(m.data.s !== myId) renderMsg(m.data.t, false); });
        }

        function send() {
            const i = document.getElementById('msgInput'); if(!i.value || !currentChannel) return;
            currentChannel.publish('msg', {t: i.value, s: myId});
            renderMsg(i.value, true); i.value = "";
        }

        function renderMsg(t, m) {
            const d = document.createElement('div'); d.className = 'msg ' + (m ? 'mine' : 'others');
            d.textContent = t; document.getElementById('messages').appendChild(d);
            document.getElementById('messages').scrollTop = 99999;
        }
        render();
    </script>
</body>
</html>