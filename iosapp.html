<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iOS Messenger</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5968/5968771.png">

    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --ios-blue: #007AFF; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: #000; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; 
        }
        #header { 
            padding-top: env(safe-area-inset-top); background: #121212; 
            text-align: center; padding-bottom: 10px; border-bottom: 0.5px solid #333;
        }
        #sidebar-mobile { display: flex; overflow-x: auto; padding: 10px; gap: 10px; background: #121212; }
        .contact-dot { 
            min-width: 60px; height: 60px; background: #262626; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 10px; border: 2px solid var(--ios-blue);
        }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px 16px; border-radius: 20px; max-width: 75%; font-size: 16px; }
        .mine { background: var(--ios-blue); align-self: flex-end; }
        .others { background: #262626; align-self: flex-start; }
        .input-area { 
            padding: 10px; padding-bottom: env(safe-area-inset-bottom); 
            background: #121212; display: flex; gap: 10px; align-items: center;
        }
        input { flex: 1; background: #1c1c1e; border: 1px solid #3a3a3c; color: white; padding: 10px 15px; border-radius: 20px; outline: none; }
        #my-id { font-size: 10px; color: gray; text-align: center; }
    </style>
</head>
<body>
    <div id="header">
        <div id="my-id">Загрузка ID...</div>
        <div id="chat-with">Выберите контакт</div>
    </div>
    <div id="sidebar-mobile">
        <div class="contact-dot" onclick="addContact()">+</div>
        <div id="contactList" style="display:flex; gap:10px;"></div>
    </div>
    <div id="messages"></div>
    <div class="input-area">
        <input type="text" id="msgInput" placeholder="Сообщение...">
        <button onclick="send()" style="background:none; border:none; color:var(--ios-blue); font-weight:bold; font-size:17px;">Отпр.</button>
    </div>

    <script>
        const API_KEY = 'M9FSjQ.1eCbcw:gmIuogBbVXZnMUew6GlHaBQBCmrsBDyNTNiz_vtR-r0';
        const ably = new Ably.Realtime(API_KEY);
        let myId = localStorage.getItem('messenger_id_ios') || 'ios-' + Math.random().toString(36).substr(2, 5);
        localStorage.setItem('messenger_id_ios', myId);
        document.getElementById('my-id').textContent = "Ваш ID: " + myId;

        let currentChannel = null;
        let contacts = JSON.parse(localStorage.getItem('ios_contacts') || '[]');

        ably.channels.get('private:' + myId).subscribe('add_me', m => {
            if (!contacts.includes(m.data.id)) { contacts.push(m.data.id); save(); }
        });

        function save() { localStorage.setItem('ios_contacts', JSON.stringify(contacts)); renderContacts(); }

        function renderContacts() {
            const list = document.getElementById('contactList');
            list.innerHTML = "";
            contacts.forEach(id => {
                const d = document.createElement('div');
                d.className = 'contact-dot'; d.textContent = id;
                d.onclick = () => startChat(id);
                list.appendChild(d);
            });
        }

        function addContact() { const id = prompt("ID друга:"); if(id) { contacts.push(id); save(); startChat(id); } }

        function startChat(id) {
            if(currentChannel) currentChannel.unsubscribe();
            document.getElementById('chat-with').textContent = "Чат: " + id;
            document.getElementById('messages').innerHTML = "";
            ably.channels.get('private:' + id).publish('add_me', {id: myId});
            const room = [myId, id].sort().join('_');
            currentChannel = ably.channels.get(room);
            currentChannel.subscribe('msg', m => { if(m.data.s !== myId) renderMsg(m.data.t, false); });
        }

        function send() {
            const i = document.getElementById('msgInput');
            if(!i.value || !currentChannel) return;
            currentChannel.publish('msg', {t: i.value, s: myId});
            renderMsg(i.value, true); i.value = "";
        }

        function renderMsg(t, m) {
            const d = document.createElement('div');
            d.className = 'msg ' + (m ? 'mine' : 'others');
            d.textContent = t;
            document.getElementById('messages').appendChild(d);
            document.getElementById('messages').scrollTop = 99999;
        }
        renderContacts();
    </script>
</body>
</html>