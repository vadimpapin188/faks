<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Faks iOS</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Faks">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #000; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        #toolbar { background: #1c1c1e; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid #333; }
        #my-id-info { background: #000; font-size: 11px; padding: 5px 15px; color: #888; display: flex; justify-content: space-between; }
        #contacts-bar { background: #000; padding: 10px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 0.5px solid #333; }
        .c-item { background: #1c1c1e; padding: 10px 15px; border-radius: 10px; white-space: nowrap; border-left: 3px solid #007aff; cursor: pointer; }
        .c-item.active { background: #2c2c2e; border-left-color: #fff; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 75%; line-height: 1.4; font-size: 16px; }
        .mine { background: #007aff; align-self: flex-end; border-bottom-right-radius: 4px; }
        .others { background: #262629; align-self: flex-start; border-bottom-left-radius: 4px; }
        .secret { border: 1px dashed #ff4500; }
        .input-box { background: #1c1c1e; padding: 10px 15px 25px 15px; display: flex; flex-direction: column; gap: 8px; }
        .input-row { display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; background: #2c2c2e; border: none; color: white; padding: 10px 15px; border-radius: 20px; outline: none; font-size: 16px; }
        button { background: #007aff; border: none; color: white; border-radius: 20px; padding: 8px 18px; font-weight: 600; }
        #install-hint { background: #007aff; color: white; padding: 8px; font-size: 12px; text-align: center; display: none; }
    </style>
</head>
<body>
    <div id="install-hint" onclick="this.style.display='none'">Нажми «Поделиться» → «На экран Домой»</div>
    <div id="toolbar">
        <span id="chat-title">Faks iOS</span>
        <button onclick="addContact()" style="background:#2c2c2e; font-size:12px;">+ КОНТАКТ</button>
    </div>
    <div id="my-id-info">
        <span id="my-id-text">ID: загрузка...</span>
        <span onclick="requestNotify()" style="color:#007aff; cursor:pointer;">ВКЛ. УВЕДОМЛЕНИЯ</span>
    </div>
    <div id="contacts-bar"></div>
    <div id="messages"></div>
    <div class="input-box">
        <div style="display:flex; justify-content: space-between;">
            <label style="font-size: 12px; color: #ff4500;"><input type="checkbox" id="isSecret"> СЕКРЕТНО</label>
            <span onclick="clearHist()" style="color:#555; font-size:12px; cursor:pointer;">ОЧИСТИТЬ</span>
        </div>
        <div class="input-row">
            <input type="text" id="msgInput" placeholder="Сообщение..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()">↑</button>
        </div>
    </div>

<script>
    if (window.navigator.standalone === false) { document.getElementById('install-hint').style.display = 'block'; }

    const API_KEY = 'M9FSjQ.1eCbcw:gmIuogBbVXZnMUew6GlHaBQBCmrsBDyNTNiz_vtR-r0';
    const ably = new Ably.Realtime(API_KEY);
    let myId = localStorage.getItem('faks_myid_ios') || 'ios-' + Math.random().toString(36).substr(2, 5);
    localStorage.setItem('faks_myid_ios', myId);
    document.getElementById('my-id-text').textContent = "Ваш ID: " + myId;

    let currentChannel = null;
    let activeId = null;
    let contacts = JSON.parse(localStorage.getItem('ios_contacts') || '[]');

    async function requestNotify() {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') alert("Уведомления включены!");
    }

    function save() { localStorage.setItem('ios_contacts', JSON.stringify(contacts)); render(); }

    function addContact() {
        const id = prompt("ID друга:"); if (!id) return;
        const name = prompt("Имя:"); if (!name) return;
        if(!contacts.find(c => c.id === id)) { contacts.push({id, name}); save(); }
    }

    function render() {
        const bar = document.getElementById('contacts-bar');
        bar.innerHTML = "";
        contacts.forEach(c => {
            const d = document.createElement('div');
            d.className = 'c-item' + (activeId === c.id ? ' active' : '');
            d.textContent = c.name;
            d.onclick = () => startChat(c.id, c.name);
            bar.appendChild(d);
        });
    }

    function startChat(id, name) {
        if(currentChannel) currentChannel.unsubscribe();
        activeId = id;
        render();
        document.getElementById('chat-title').textContent = name;
        document.getElementById('messages').innerHTML = "";
        const room = [myId, id].sort().join('_');
        currentChannel = ably.channels.get(room);
        
        const hist = JSON.parse(localStorage.getItem('h_'+id) || '[]');
        hist.forEach(m => renderMsg(m.t, m.s === myId, false));

        currentChannel.subscribe('msg', m => {
            if(m.data.s !== myId) {
                if(!m.data.sec) saveMsg(id, m.data.t, m.data.s);
                renderMsg(m.data.t, false, m.data.sec);
                if (document.hidden) { new Notification("Faks: " + name, { body: m.data.t }); }
            }
        });
    }

    function send() {
        const i = document.getElementById('msgInput');
        const sec = document.getElementById('isSecret').checked;
        if(!i.value || !currentChannel) return;
        currentChannel.publish('msg', {t: i.value, s: myId, sec: sec});
        if(!sec) saveMsg(activeId, i.value, myId);
        renderMsg(i.value, true, sec);
        i.value = "";
    }

    function saveMsg(cid, t, s) {
        let h = JSON.parse(localStorage.getItem('h_'+cid) || '[]');
        h.push({t, s}); if(h.length > 50) h.shift();
        localStorage.setItem('h_'+cid, JSON.stringify(h));
    }

    function renderMsg(t, m, sec) {
        const d = document.createElement('div');
        d.className = 'msg ' + (m ? 'mine' : 'others') + (sec ? ' secret' : '');
        d.textContent = t;
        document.getElementById('messages').appendChild(d);
        document.getElementById('messages').scrollTop = 99999;
        if(sec) setTimeout(() => d.remove(), 60000);
    }

    function clearHist() { if(activeId) { localStorage.removeItem('h_'+activeId); document.getElementById('messages').innerHTML = ""; } }
    render();

    setInterval(() => {
        if (document.hidden && currentChannel) {
            currentChannel.publish('ping', { time: Date.now(), s: myId });
        }
    }, 20000);
</script>
</body>
</html>
