<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Faks iOS</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Faks">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #000; color: white; margin: 0; display: flex; 
            flex-direction: column; height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        #toolbar { background: #1c1c1e; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid #333; }
        #status-info { background: #000; font-size: 11px; padding: 5px 15px; color: #888; display: flex; justify-content: space-between; }
        #contacts-bar { background: #000; padding: 10px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 0.5px solid #333; }
        .c-item { background: #1c1c1e; padding: 10px 15px; border-radius: 10px; white-space: nowrap; border-left: 3px solid #007aff; }
        .c-item.active { background: #2c2c2e; border-left-color: #fff; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 75%; font-size: 16px; line-height: 1.4; }
        .mine { background: #007aff; align-self: flex-end; border-bottom-right-radius: 4px; }
        .others { background: #262629; align-self: flex-start; border-bottom-left-radius: 4px; }
        .secret { border: 1px dashed #ff4500; }
        .input-box { background: #1c1c1e; padding: 10px 15px 25px; display: flex; flex-direction: column; gap: 8px; }
        .input-row { display: flex; gap: 10px; align-items: center; }
        input { flex: 1; background: #2c2c2e; border: none; color: white; padding: 12px; border-radius: 20px; outline: none; font-size: 16px; }
        button { background: #007aff; border: none; color: white; border-radius: 20px; padding: 8px 18px; font-weight: 600; }
        #dot { width: 8px; height: 8px; background: #ff3b30; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: #4cd964 !important; }
    </style>
</head>
<body>
    <div id="toolbar">
        <span><div id="dot"></div> <span id="chat-title">Faks iOS</span></span>
        <button onclick="addContact()" style="background:#2c2c2e; font-size:12px;">+ КОНТАКТ</button>
    </div>
    <div id="status-info">
        <span id="my-id-text">ID: ...</span>
        <span onclick="Notification.requestPermission()" style="color:#007aff;">ВКЛ. УВЕДОМЛЕНИЯ</span>
    </div>
    <div id="contacts-bar"></div>
    <div id="messages"></div>
    <div class="input-box">
        <div style="display:flex; justify-content: space-between;">
            <label style="font-size: 12px; color: #ff4500;"><input type="checkbox" id="isSecret"> СЕКРЕТНО</label>
            <span onclick="clearHist()" style="color:#555; font-size:12px;">ОЧИСТИТЬ</span>
        </div>
        <div class="input-row">
            <input type="text" id="msgInput" placeholder="Сообщение..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()">↑</button>
        </div>
    </div>

<script>
    const API_KEY = 'M9FSjQ.1eCbcw:gmIuogBbVXZnMUew6GlHaBQBCmrsBDyNTNiz_vtR-r0';
    const ably = new Ably.Realtime({ key: API_KEY, transportParams: { heartbeatInterval: 10000 } });
    
    let myId = localStorage.getItem('faks_myid_ios') || 'ios-' + Math.random().toString(36).substr(2, 5);
    localStorage.setItem('faks_myid_ios', myId);
    document.getElementById('my-id-text').textContent = "Ваш ID: " + myId;

    let currentChannel = null;
    let activeId = null;
    let contacts = JSON.parse(localStorage.getItem('ios_contacts') || '[]');

    // Индикатор сети
    ably.connection.on('connected', () => document.getElementById('dot').className = 'online');
    ably.connection.on('disconnected', () => document.getElementById('dot').className = '');

    function save() { localStorage.setItem('ios_contacts', JSON.stringify(contacts)); render(); }

    function addContact() {
        const id = prompt("ID друга:"); const name = prompt("Имя:");
        if (id && name && !contacts.find(c => c.id === id)) { contacts.push({id, name}); save(); }
    }

    function render() {
        const bar = document.getElementById('contacts-bar');
        bar.innerHTML = "";
        contacts.forEach(c => {
            const d = document.createElement('div');
            d.className = 'c-item' + (activeId === c.id ? ' active' : '');
            d.textContent = c.name;
            d.onclick = () => startChat(c.id, c.name);
            bar.appendChild(d);
        });
    }

    function startChat(id, name) {
        if(currentChannel) currentChannel.unsubscribe();
        activeId = id;
        render();
        document.getElementById('chat-title').textContent = name;
        document.getElementById('messages').innerHTML = "";
        const room = [myId, id].sort().join('_');
        currentChannel = ably.channels.get(room);
        
        // Загрузка истории (чтобы видеть сообщения, когда зашел в приложение)
        currentChannel.history({limit: 30}, (err, page) => {
            if(!err) page.items.reverse().forEach(m => renderMsg(m.data.t, m.data.s === myId, m.data.sec));
        });

        currentChannel.subscribe('msg', m => {
            if(m.data.s !== myId) {
                if(!m.data.sec) saveMsg(id, m.data.t, m.data.s);
                renderMsg(m.data.t, false, m.data.sec);
                
                // Уведомление в фоне
                if (document.hidden) {
                    new Audio('https://www.soundjay.com/buttons/beep-07a.mp3').play();
                    if (Notification.permission === "granted") {
                        new Notification("Faks: " + name, { body: m.data.t, tag: "faks" });
                    }
                }
            }
        });
    }

    function send() {
        const i = document.getElementById('msgInput');
        const sec = document.getElementById('isSecret').checked;
        if(!i.value || !currentChannel) return;
        currentChannel.publish('msg', {t: i.value, s: myId, sec: sec});
        if(!sec) saveMsg(activeId, i.value, myId);
        renderMsg(i.value, true, sec);
        i.value = "";
    }

    function saveMsg(cid, t, s) {
        let h = JSON.parse(localStorage.getItem('h_'+cid) || '[]');
        h.push({t, s}); if(h.length > 50) h.shift();
        localStorage.setItem('h_'+cid, JSON.stringify(h));
    }

    function renderMsg(t, m, sec) {
        const d = document.createElement('div');
        d.className = 'msg ' + (m ? 'mine' : 'others') + (sec ? ' secret' : '');
        d.textContent = t;
        document.getElementById('messages').appendChild(d);
        document.getElementById('messages').scrollTop = 99999;
        if(sec) setTimeout(() => d.remove(), 60000);
    }

    function clearHist() { if(activeId) { localStorage.removeItem('h_'+activeId); document.getElementById('messages').innerHTML = ""; } }
    
    // Пинг для поддержания жизни свернутого приложения
    setInterval(() => {
        if (currentChannel) currentChannel.publish('ping', 'stay_alive');
    }, 15000);

    render();
</script>
</body>
</html>
